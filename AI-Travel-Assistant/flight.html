<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travel Assistant Chatbot</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="styles.css">
  
  <style>
    .result-card { margin-bottom: 10px; }
    #bookingsContainer .card { background: #f8f9fa; }
    #welcome-container { margin-top: 1rem; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg sticky-top bg-light">
    <div class="container">
      <a class="navbar-brand" href="chatbot.html">
        <i class="fas fa-plane"></i> TravelBot
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="chatbot.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="login.html">Login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link " href="index.html">Chatbot</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="flight.html">Flights & Hotels</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="map.html">Map</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Welcome Message and Logout Button -->
  <div class="container" id="welcome-container">
    <div class="row">
      <div class="col-md-6">
        <h5 id="welcome-msg"></h5>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Booking Sections -->
  <div class="container mt-4">
    <div class="row">
      <!-- Flight -->
      <div class="col-md-6">
        <div class="card p-3 mb-4">
          <h5><i class="fas fa-plane"></i> Book Flight</h5>
          <select id="flightFrom" class="form-select my-2"></select>
          <select id="flightTo" class="form-select my-2"></select>
          <input type="date" id="flightDate" class="form-control my-2"/>
          <button class="btn btn-primary w-100" onclick="searchFlights()">Search Flights</button>
          <div id="flightResults" class="mt-3"></div>
        </div>
      </div>
      <!-- Hotel -->
      <div class="col-md-6">
        <div class="card p-3 mb-4">
          <h5><i class="fas fa-hotel"></i> Book Hotel</h5>
          <select id="hotelCity" class="form-select my-2"></select>
          <input type="date" id="hotelCheckIn" class="form-control my-2"/>
          <input type="date" id="hotelCheckOut" class="form-control my-2"/>
          <button class="btn btn-primary w-100" onclick="searchHotels()">Search Hotels</button>
          <div id="hotelResults" class="mt-3"></div>
        </div>
      </div>
    </div>
    <button class="btn btn-info w-100 mb-3" onclick="seeBookings()">See Your Bookings</button>
    <div id="bookingsContainer"></div>
  </div>



  <script>
    const cities = [
      { name: "Karachi", airport: true }, { name: "Lahore", airport: true },
      { name: "Islamabad", airport: true }, { name: "Skardu", airport: true },
      { name: "Hunza", airport: false }, { name: "Murree", airport: false },
      { name: "Naran", airport: false }, { name: "Swat", airport: false },
      { name: "Fairy Meadows", airport: false }, { name: "Gwadar", airport: true },
      { name: "Peshawar", airport: true }, { name: "Multan", airport: true },
      { name: "Quetta", airport: true }, { name: "Hyderabad", airport: false },
      { name: "Gilgit", airport: true }, { name: "Bahawalpur", airport: true },
      { name: "Sukkur", airport: true }, { name: "Abbottabad", airport: false },
      { name: "Sialkot", airport: true }, { name: "Rahim Yar Khan", airport: true }
    ];

    const flightFrom = document.getElementById("flightFrom");
    const flightTo = document.getElementById("flightTo");
    const hotelCity = document.getElementById("hotelCity");

    async function initPage() {
      try {
        const resp = await fetch('/session-status');
        const session = await resp.json();
        if (!session.loggedIn) return window.location.href = '/login.html';
        document.getElementById('welcome-msg').innerText = `Welcome, ${session.user.name}!`;

        cities.forEach(city => {
          flightFrom.add(new Option(city.name, city.name));
          flightTo.add(new Option(city.name, city.name));
          hotelCity.add(new Option(city.name, city.name));
        });
      } catch (err) {
        window.location.href = '/login.html';
      }
    }

    window.onload = initPage;

    function getCity(name) {
      return cities.find(c => c.name === name);
    }

    function searchFlights() {
      const from = flightFrom.value, to = flightTo.value, date = document.getElementById("flightDate").value;
      if (!from || !to || !date) return alert("Please fill all flight fields.");

      const aFrom = getCity(from).airport, aTo = getCity(to).airport;
      const useFlight = aFrom && aTo;
      const dummy = useFlight
        ? [{ airline: "PIA", price: "PKR 15,000", duration: "2h 30m" }, { airline: "AirBlue", price: "PKR 18,500", duration: "2h 45m" }]
        : [{ airline: "Bus Service", price: "PKR 3,000", duration: "5h" }, { airline: "Private Cab", price: "PKR 4,500", duration: "4h" }];

      flightResults.innerHTML = dummy.map(f => `
        <div class="card result-card"><div class="card-body d-flex justify-content-between">
          <div><strong>${f.airline}</strong><br>${from} → ${to} (${date})<br><small>${f.duration}</small></div>
          <button class="btn btn-sm btn-outline-primary" onclick='book("flight",${JSON.stringify({from,to,date,price:f.price})})'>Book</button>
        </div></div>`).join("");
    }

    function searchHotels() {
      const city = hotelCity.value;
      const ci = document.getElementById("hotelCheckIn").value;
      const co = document.getElementById("hotelCheckOut").value;
      if (!city || !ci || !co) return alert("Please fill all hotel fields.");

      const dummy = [
        { name: `${city} Grand Hotel`, price: "PKR 6,000" },
        { name: `${city} View Inn`, price: "PKR 8,500" }
      ];

      hotelResults.innerHTML = dummy.map(h => `
        <div class="card result-card"><div class="card-body d-flex justify-content-between">
          <div><strong>${h.name}</strong><br>${city} (${ci} → ${co})</div>
          <button class="btn btn-sm btn-outline-primary" onclick='book("hotel",${JSON.stringify({city,checkIn:ci,checkOut:co,price:h.price})})'>Book</button>
        </div></div>`).join("");
    }

    async function book(type, details) {
      const res = await fetch('/book', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ type, details })
      });
      const j = await res.json();
      alert(j.message || 'Booking successful!');
    }

    async function seeBookings() {
  const arr = await fetch('/bookings').then(r => r.json());
  const container = document.getElementById("bookingsContainer");
  container.innerHTML = '';

  if (!arr.length) {
    container.innerHTML = '<p>No bookings yet.</p>';
    return;
  }

  arr.forEach((b, i) => {
    const card = document.createElement('div');
    card.className = 'card mb-2';
    card.id = `booking-${b._id}`;
    card.innerHTML = `
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <strong>${i + 1}. ${b.type.toUpperCase()}</strong><br>
          ${b.type === 'flight'
            ? `${b.details.from} → ${b.details.to} on ${b.details.date}`
            : `${b.details.city} (${b.details.checkIn} → ${b.details.checkOut})`}<br>
          Price: ${b.details.price}
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteBooking('${b._id}')">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    `;
    container.appendChild(card);
  });
}
async function deleteBooking(bookingId) {
  const confirmDelete = confirm("Are you sure you want to delete this booking?");
  if (!confirmDelete) return;

  try {
    const res = await fetch(`/delete-booking/${bookingId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    const data = await res.json();

    if (res.ok) {
      alert(data.message);
      const element = document.getElementById(`booking-${bookingId}`);
      if (element) element.remove();
    } else {
      alert(data.message || "Failed to delete booking");
    }
  } catch (error) {
    console.error("Error deleting booking:", error);
    alert("Something went wrong while deleting the booking.");
  }
}


    async function logout() {
      await fetch('/logout');
      window.location.href = '/login.html';
    }
  </script>
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>TravelBot</h5>
                    <p>Your AI-powered travel companion for seamless journey planning.</p>
                </div>
                <div class="col-md-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-light text-decoration-none">Privacy Policy</a></li>
                        <li><a href="#" class="text-light text-decoration-none">Terms of Service</a></li>
                        <li><a href="#" class="text-light text-decoration-none">Contact Us</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact</h5>
                    <p><i class="fas fa-envelope"></i> support@travelbot.com</p>
                    <p><i class="fas fa-phone"></i> +1 (555) 123-4567</p>
                </div>
            </div>
            <hr class="my-4">
            <div class="text-center">
                <p>&copy; 2025 TravelBot. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>